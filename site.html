<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Air Monitor Data Dashboard</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_files/libs/clipboard/clipboard.min.js"></script>
<script src="site_files/libs/quarto-html/quarto.js"></script>
<script src="site_files/libs/quarto-html/popper.min.js"></script>
<script src="site_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_files/libs/quarto-html/anchor.min.js"></script>
<link href="site_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="site_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_files/libs/bootstrap/bootstrap-973236bd072d72a04ee9cd82dcc9cb29.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="bslib-page-fill bslib-gap-spacing bslib-flow-mobile html-fill-container fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Air Monitor Data Dashboard</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Southern California consistently experiences the worst air quality in the country. This is especially clear in the Inland Empire, where there is heavy warehousing and constant truck traffic near residential areas. Despite air quality being worse, very little data is collected in this region. You can look at any government or community air monitor map and see a huge gap in data east of Los Angeles, even though millions of people live there and experience unhealthy air every day.</p>
<p>In a partnership between the Robert Redford Conservancy at Pitzer College, the Center for Community Action and Environmental Justice, and IQAir, 58 particulate air quality monitors have been installed at community members’ homes. After over a year of data collection, this dashboard provides interactive tools to visualize and analyze all of that collected data.</p>
<div class="cell">
<div class="cell-output-display">

<div class="card bslib-card bslib-mb-spacing html-fill-item html-fill-container" data-bslib-card-init="" data-require-bs-caller="card()" data-require-bs-version="5">
<div class="card-header">
<ul class="nav nav-tabs shiny-tab-input card-header-tabs" id="tabs" data-tabsetid="9426">
<li class="active">
<a href="#tab-9426-1" data-toggle="tab" data-bs-toggle="tab" data-value="PM2.5 Air Quality">PM2.5 Air Quality</a>
</li>
<li>
<a href="#tab-9426-2" data-toggle="tab" data-bs-toggle="tab" data-value="Air Quality Over Time">Air Quality Over Time</a>
</li>
<li>
<a href="#tab-9426-3" data-toggle="tab" data-bs-toggle="tab" data-value="Air Quality by City">Air Quality by City</a>
</li>
<li>
<a href="#tab-9426-4" data-toggle="tab" data-bs-toggle="tab" data-value="Indoor vs Outdoor">Indoor vs Outdoor</a>
</li>
</ul>
</div>
<div class="tab-content html-fill-item html-fill-container" data-tabsetid="9426">
<div class="tab-pane active html-fill-item html-fill-container bslib-gap-spacing" data-value="PM2.5 Air Quality" id="tab-9426-1" style="gap:0;padding:0;">
<div class="card-body bslib-gap-spacing html-fill-item html-fill-container" style="margin-top:auto;margin-bottom:auto;flex:1 1 auto;">
<div class="card bslib-card bslib-mb-spacing html-fill-item html-fill-container" data-bslib-card-init="" data-require-bs-caller="card()" data-require-bs-version="5">
<div class="card-body bslib-gap-spacing html-fill-item html-fill-container" style="margin-top:auto;margin-bottom:auto;flex:1 1 auto;">
                  While PM2.5 air quality in Southern California is worse than the recommended levels by the state and federal government, it's much worse in Fontana, Bloomington, and Rialto, which can pose significant risks to residents' respiratory health.
                  
                  Here, you can compare particulate matter levels from air quality monitors in different regions, alongside a couple of health standards from government bodies. 
                  </div>
<script data-bslib-card-init="">bslib.Card.initializeAllCards();</script>
</div>
</div>
<div class="bslib-sidebar-layout bslib-mb-spacing html-fill-item" data-bslib-sidebar-init="TRUE" data-collapsible-desktop="true" data-collapsible-mobile="true" data-open-desktop="open" data-open-mobile="closed" data-require-bs-caller="layout_sidebar()" data-require-bs-version="5" style="--_sidebar-width:250px;">
<div class="main bslib-gap-spacing html-fill-container">
<div class="shiny-plot-output html-fill-item" id="barchartCombined" style="width:100%;height:400px;"></div>
</div>
<aside id="bslib-sidebar-3449" class="sidebar" hidden="">
<div class="sidebar-content bslib-gap-spacing">
<div id="chosenMeasure" class="form-group shiny-input-radiogroup shiny-input-container" role="radiogroup" aria-labelledby="chosenMeasure-label">
<label class="control-label" id="chosenMeasure-label" for="chosenMeasure">Air Quality Measurement:</label>
<div class="shiny-options-group">
<div class="radio">
<label>
<input type="radio" name="chosenMeasure" value="PM2.5" checked="checked">
<span>PM2.5</span>
</label>
</div>
<div class="radio">
<label>
<input type="radio" name="chosenMeasure" value="AQI">
<span>AQI</span>
</label>
</div>
</div>
</div>
<div id="chosenSelection" class="form-group shiny-input-checkboxgroup shiny-input-container" role="group" aria-labelledby="chosenSelection-label">
<label class="control-label" id="chosenSelection-label" for="chosenSelection">Data:</label>
<div class="shiny-options-group">
<div class="checkbox">
<label>
<input type="checkbox" name="chosenSelection" value="Inland Empire 2025" checked="checked">
<span>Inland Empire 2025</span>
</label>
</div>
<div class="checkbox">
<label>
<input type="checkbox" name="chosenSelection" value="WHO Guideline" checked="checked">
<span>WHO Guideline</span>
</label>
</div>
<div class="checkbox">
<label>
<input type="checkbox" name="chosenSelection" value="EPA Standard" checked="checked">
<span>EPA Standard</span>
</label>
</div>
<div class="checkbox">
<label>
<input type="checkbox" name="chosenSelection" value="US" checked="checked">
<span>US</span>
</label>
</div>
<div class="checkbox">
<label>
<input type="checkbox" name="chosenSelection" value="SoCal" checked="checked">
<span>SoCal</span>
</label>
</div>
<div class="checkbox">
<label>
<input type="checkbox" name="chosenSelection" value="Los Angeles">
<span>Los Angeles</span>
</label>
</div>
<div class="checkbox">
<label>
<input type="checkbox" name="chosenSelection" value="San Diego">
<span>San Diego</span>
</label>
</div>
</div>
</div>
</div>
</aside>
<button class="collapse-toggle" type="button" title="Toggle sidebar" aria-expanded="true" aria-controls="bslib-sidebar-3449"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" class="bi bi-chevron-left collapse-icon" style="fill:currentColor;" aria-hidden="true" role="img"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"></path></svg></button>
<script data-bslib-sidebar-init="">bslib.Sidebar.initCollapsibleAll()</script>
</div>
</div>
<div class="tab-pane html-fill-item html-fill-container bslib-gap-spacing" data-value="Air Quality Over Time" id="tab-9426-2" style="gap:0;padding:0;">
<div class="card-body bslib-gap-spacing html-fill-item html-fill-container" style="margin-top:auto;margin-bottom:auto;flex:1 1 auto;">
<div class="card bslib-card bslib-mb-spacing html-fill-item html-fill-container" data-bslib-card-init="" data-require-bs-caller="card()" data-require-bs-version="5">
<div class="card-body bslib-gap-spacing html-fill-item html-fill-container" style="margin-top:auto;margin-bottom:auto;flex:1 1 auto;">
                  Air quality in the Inland Empire fluctuates over time. However, it's almost always worse than the rest of SoCal, and it's always unhealthy. 
                  
                  Here, you can see how regional air quality changed over the first year of air monitoring.
                  </div>
<script data-bslib-card-init="">bslib.Card.initializeAllCards();</script>
</div>
</div>
<div class="bslib-sidebar-layout bslib-mb-spacing html-fill-item" data-bslib-sidebar-init="TRUE" data-collapsible-desktop="true" data-collapsible-mobile="true" data-open-desktop="open" data-open-mobile="closed" data-require-bs-caller="layout_sidebar()" data-require-bs-version="5" style="--_sidebar-width:250px;">
<div class="main bslib-gap-spacing html-fill-container">
<div id="bslib-accordion-3835" class="accordion" data-require-bs-version="5" data-require-bs-caller="accordion()">
<div class="accordion-item" data-value="PM2.5">
<div class="accordion-header">
<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#bslib-accordion-panel-1093" aria-controls="bslib-accordion-panel-1093" aria-expanded="true">
<div class="accordion-icon"></div>
<div class="accordion-title">PM2.5</div>
</button>
</div>
<div id="bslib-accordion-panel-1093" class="accordion-collapse collapse show">
<div class="accordion-body">
<div class="shiny-plot-output html-fill-item" id="timeseries" style="width:100%;height:400px;"></div>
</div>
</div>
</div>
</div>
</div>
<aside id="bslib-sidebar-7102" class="sidebar" hidden="">
<div class="sidebar-content bslib-gap-spacing">
<div class="form-group shiny-input-container">
<label class="control-label" id="daterange-label" for="daterange">Dates:</label>
<input class="js-range-slider" id="daterange" data-skin="shiny" data-type="double" data-min="1738454400000" data-max="1762473600000" data-from="1738454400000" data-to="1762473600000" data-step="86400000" data-grid="true" data-grid-num="9.92857142857143" data-grid-snap="false" data-prettify-separator="," data-prettify-enabled="true" data-keyboard="true" data-drag-interval="true" data-data-type="date" data-time-format="%Y-%m-%d">
</div>
<div id="realdaterange" class="shiny-date-range-input form-group shiny-input-container">
<label class="control-label" id="realdaterange-label" for="realdaterange">Dates</label>
<div class="input-daterange input-group input-group-sm">
<input class="form-control" type="text" aria-labelledby="realdaterange-label" title="Date format: yyyy-mm-dd" data-date-language="en" data-date-week-start="0" data-date-format="yyyy-mm-dd" data-date-start-view="month" data-min-date="2025-02-02" data-max-date="2025-11-07" data-initial-date="2025-02-02" data-date-autoclose="true">
<span class="input-group-addon input-group-prepend input-group-append">
<span class="input-group-text"> to </span>
</span>
<input class="form-control" type="text" aria-labelledby="realdaterange-label" title="Date format: yyyy-mm-dd" data-date-language="en" data-date-week-start="0" data-date-format="yyyy-mm-dd" data-date-start-view="month" data-min-date="2025-02-02" data-max-date="2025-11-07" data-initial-date="2025-11-07" data-date-autoclose="true">
</div>
</div>
<div id="chosenTimescale" class="form-group shiny-input-radiogroup shiny-input-container" role="radiogroup" aria-labelledby="chosenTimescale-label">
<label class="control-label" id="chosenTimescale-label" for="chosenTimescale">Temporal Resolution:</label>
<div class="shiny-options-group">
<div class="radio">
<label>
<input type="radio" name="chosenTimescale" value="Daily">
<span>Daily</span>
</label>
</div>
<div class="radio">
<label>
<input type="radio" name="chosenTimescale" value="Weekly" checked="checked">
<span>Weekly</span>
</label>
</div>
<div class="radio">
<label>
<input type="radio" name="chosenTimescale" value="Monthly">
<span>Monthly</span>
</label>
</div>
</div>
</div>
</div>
</aside>
<button class="collapse-toggle" type="button" title="Toggle sidebar" aria-expanded="true" aria-controls="bslib-sidebar-7102"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" class="bi bi-chevron-left collapse-icon" style="fill:currentColor;" aria-hidden="true" role="img"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"></path></svg></button>
<script data-bslib-sidebar-init="">bslib.Sidebar.initCollapsibleAll()</script>
</div>
</div>
<div class="tab-pane html-fill-item html-fill-container bslib-gap-spacing" data-value="Air Quality by City" id="tab-9426-3" style="gap:0;padding:0;">
<div class="card-body bslib-gap-spacing html-fill-item html-fill-container" style="margin-top:auto;margin-bottom:auto;flex:1 1 auto;">
<div class="card bslib-card bslib-mb-spacing html-fill-item html-fill-container" data-bslib-card-init="" data-require-bs-caller="card()" data-require-bs-version="5">
<div class="card-body bslib-gap-spacing html-fill-item html-fill-container" style="margin-top:auto;margin-bottom:auto;flex:1 1 auto;">
  Bloomington, Fontana, and Rialto are neighboring cities. Despite slightly different levels of warehouse burdening, each city experiences very similar trends related to air quality and particulates.
                  </div>
<script data-bslib-card-init="">bslib.Card.initializeAllCards();</script>
</div>
</div>
<div class="bslib-sidebar-layout bslib-mb-spacing html-fill-item" data-bslib-sidebar-init="TRUE" data-collapsible-desktop="true" data-collapsible-mobile="true" data-open-desktop="open" data-open-mobile="closed" data-require-bs-caller="layout_sidebar()" data-require-bs-version="5" style="--_sidebar-width:250px;">
<div class="main bslib-gap-spacing html-fill-container">
<div id="bslib-accordion-4482" class="accordion" data-require-bs-version="5" data-require-bs-caller="accordion()">
<div class="accordion-item" data-value="PM2.5">
<div class="accordion-header">
<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#bslib-accordion-panel-6326" aria-controls="bslib-accordion-panel-6326" aria-expanded="true">
<div class="accordion-icon"></div>
<div class="accordion-title">PM2.5</div>
</button>
</div>
<div id="bslib-accordion-panel-6326" class="accordion-collapse collapse show">
<div class="accordion-body">
<div class="shiny-plot-output html-fill-item" id="citychart" style="width:100%;height:400px;"></div>
</div>
</div>
</div>
</div>
</div>
<aside id="bslib-sidebar-2347" class="sidebar" hidden="">
<div class="sidebar-content bslib-gap-spacing">
<div id="chosenCity" class="form-group shiny-input-checkboxgroup shiny-input-container" role="group" aria-labelledby="chosenCity-label">
<label class="control-label" id="chosenCity-label" for="chosenCity">Cities:</label>
<div class="shiny-options-group">
<div class="checkbox">
<label>
<input type="checkbox" name="chosenCity" value="Bloomington" checked="checked">
<span>Bloomington</span>
</label>
</div>
<div class="checkbox">
<label>
<input type="checkbox" name="chosenCity" value="Fontana" checked="checked">
<span>Fontana</span>
</label>
</div>
<div class="checkbox">
<label>
<input type="checkbox" name="chosenCity" value="Rialto" checked="checked">
<span>Rialto</span>
</label>
</div>
</div>
</div>
</div>
</aside>
<button class="collapse-toggle" type="button" title="Toggle sidebar" aria-expanded="true" aria-controls="bslib-sidebar-2347"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" class="bi bi-chevron-left collapse-icon" style="fill:currentColor;" aria-hidden="true" role="img"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"></path></svg></button>
<script data-bslib-sidebar-init="">bslib.Sidebar.initCollapsibleAll()</script>
</div>
</div>
<div class="tab-pane html-fill-item html-fill-container bslib-gap-spacing" data-value="Indoor vs Outdoor" id="tab-9426-4" style="gap:0;padding:0;">
<div class="card-body bslib-gap-spacing html-fill-item html-fill-container" style="margin-top:auto;margin-bottom:auto;flex:1 1 auto;">
<div class="card bslib-card bslib-mb-spacing html-fill-item html-fill-container" data-bslib-card-init="" data-require-bs-caller="card()" data-require-bs-version="5">
<div class="card-body bslib-gap-spacing html-fill-item html-fill-container" style="margin-top:auto;margin-bottom:auto;flex:1 1 auto;">
  Indoor vs outdoor PM2.5 by month</div>
<script data-bslib-card-init="">bslib.Card.initializeAllCards();</script>
</div>
</div>
<div class="bslib-sidebar-layout bslib-mb-spacing html-fill-item" data-bslib-sidebar-init="TRUE" data-collapsible-desktop="true" data-collapsible-mobile="true" data-open-desktop="open" data-open-mobile="closed" data-require-bs-caller="layout_sidebar()" data-require-bs-version="5" style="--_sidebar-width:250px;">
<div class="main bslib-gap-spacing html-fill-container">
<div id="bslib-accordion-9875" class="accordion" data-require-bs-version="5" data-require-bs-caller="accordion()">
<div class="accordion-item" data-value="PM2.5">
<div class="accordion-header">
<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#bslib-accordion-panel-4246" aria-controls="bslib-accordion-panel-4246" aria-expanded="true">
<div class="accordion-icon"></div>
<div class="accordion-title">PM2.5</div>
</button>
</div>
<div id="bslib-accordion-panel-4246" class="accordion-collapse collapse show">
<div class="accordion-body">
<div class="shiny-plot-output html-fill-item" id="in_out_chart" style="width:100%;height:400px;"></div>
</div>
</div>
</div>
</div>
</div>
<aside id="bslib-sidebar-8510" class="sidebar" hidden="">
<div class="sidebar-content bslib-gap-spacing">
<div id="chosenCity" class="form-group shiny-input-checkboxgroup shiny-input-container" role="group" aria-labelledby="chosenCity-label">
<label class="control-label" id="chosenCity-label" for="chosenCity">Cities:</label>
<div class="shiny-options-group">
<div class="checkbox">
<label>
<input type="checkbox" name="chosenCity" value="Bloomington" checked="checked">
<span>Bloomington</span>
</label>
</div>
<div class="checkbox">
<label>
<input type="checkbox" name="chosenCity" value="Fontana" checked="checked">
<span>Fontana</span>
</label>
</div>
<div class="checkbox">
<label>
<input type="checkbox" name="chosenCity" value="Rialto" checked="checked">
<span>Rialto</span>
</label>
</div>
</div>
</div>
<div id="chosenTimescale" class="form-group shiny-input-radiogroup shiny-input-container" role="radiogroup" aria-labelledby="chosenTimescale-label">
<label class="control-label" id="chosenTimescale-label" for="chosenTimescale">Temporal Resolution:</label>
<div class="shiny-options-group">
<div class="radio">
<label>
<input type="radio" name="chosenTimescale" value="Daily">
<span>Daily</span>
</label>
</div>
<div class="radio">
<label>
<input type="radio" name="chosenTimescale" value="Weekly" checked="checked">
<span>Weekly</span>
</label>
</div>
<div class="radio">
<label>
<input type="radio" name="chosenTimescale" value="Monthly">
<span>Monthly</span>
</label>
</div>
</div>
</div>
</div>
</aside>
<button class="collapse-toggle" type="button" title="Toggle sidebar" aria-expanded="true" aria-controls="bslib-sidebar-8510"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" class="bi bi-chevron-left collapse-icon" style="fill:currentColor;" aria-hidden="true" role="img"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"></path></svg></button>
<script data-bslib-sidebar-init="">bslib.Sidebar.initCollapsibleAll()</script>
</div>
</div>
</div>
<script data-bslib-card-init="">bslib.Card.initializeAllCards();</script>
</div>

</div>
</div>
<p>
<script type="application/shiny-prerendered" data-context="server-start">
library(tidyverse)
library(readxl)
library(tidygeocoder)
library(writexl)
library(rsconnect)
library(bslib)
</script>
 
<script type="application/shiny-prerendered" data-context="server-start">
monitors <- read_excel("data/airmonitors_addresses.xlsx", 1)

monitors <- monitors |>
  mutate(full_address = str_c(address, 
                              city, 
                              "CA", 
                              sep = ", "))

# Searches for coordinates for each address
monitors <- geocode(monitors, 
                    address = full_address, 
                    method = 'census') 

#monitors_osm <- geocode(monitors, address = full_address) |>
  #select(monitor, serial, address, city, location, full_address, lat, long)

# One of the addresses doesn't work with the census method so this fills it in manually
monitors$lat[33] <- 34.03781
monitors$long[33] <- -117.4836

# The main data spreadsheets have the serial numbers in all lowercase so this matches it to that
coords <- monitors |> 
  mutate(Source = str_to_lower(serial)) |>
  select(lat, 
         long, 
         location,
         Source)
</script>
 
<script type="application/shiny-prerendered" data-context="server-start">
# Unzip the IQAir data export into the RRC_IQAir/data/ folder.

# Fill in the bounds of the dataset and the rate of data collection. 
# end_date should be the date after (if the data ends on August 31 it should be 01Sep25)
start_date <- '01Jan25'
end_date <-  '07Nov25'
frequency <- 'hourly'
data_info <- str_c(start_date, 
                   '-',
                   end_date, 
                   '_', 
                   frequency)

dataset_folder <- str_c('data/IQAir_Export_raw_devices_', 
                        data_info)

# Gets the number of files in the dataset folder (so it knows how many times to run the import)
monitor_count <- as.numeric(str_extract(length(list.files(dataset_folder)), 
                                        '\\d+'))
#monitor_count <- as.numeric(str_extract(length(list.files('/data')), '\\d+'))

# Runs 58 times. Goes through each serial number in the master list, finds the corresponding csv file, adds it to one big table one after the other.
import_data <- function(dataset_folder) {
  for (i in 1:monitor_count) {
    current_directory <- str_c(dataset_folder, 
                               '/IQAir_raw_', 
                               coords$Source[i], 
                               '_', 
                               data_info, 
                               '.csv')
    if (i == 1) {
      big_table <- read_csv(current_directory)
    } else {
      current_table <- read_csv(current_directory)
      big_table <- bind_rows(big_table, 
                             current_table)
    }
  }
  return(big_table)
}

data <- import_data(dataset_folder)

data_prepared <- data |>
  left_join(coords, by = 'Source') |>
  mutate(datetime = mdy_hm(`Datetime_start(UTC)`)) |>
  mutate(month = month(datetime),
         day = day(datetime)) |>
  mutate(color = cut(`AQI US`,
                      labels = c('green', 'yellow', 'orange', 'red', 'purple', 'maroon'),
                      breaks <- c(0, 50, 100, 150, 200, 300, Inf),
                      right = T))

</script>
 
<script type="application/shiny-prerendered" data-context="server">
variables_names_to_ids <- c("new" = "old")
variables_ids_to_units <- c()

pm25_colors <- c(
  "WHO Guideline"        = "#55cc22",
  "San Diego"            = "#eedd44",
  "US"                   = "#e9bb44",
  "EPA Standard"         = "#dd9944",
  "Los Angeles"          = "#dd6644",
  "SoCal"                = "#e55555",
  "Inland Empire 2025"   = "#ee4433"
)

# 2025 Los Angeles: 9.79 PM
# 2025 Los Angeles: 51.75 AQI
# 2025 San Diego: 6.98 PM2.5
# 2025 San Diego: 39.42 AQI

output$barchartCombined <- renderPlot({
  req(input$chosenSelection)
  if (input$chosenMeasure == "PM2.5") {
    average_data <- data_prepared |>
      filter(location == "outdoor") |>
      summarize(
        x = "Inland Empire 2025",
        average_pm25 = mean(`PM2.5 (ug/m3)`, na.rm = TRUE)
      ) |>
      bind_rows(
        data.frame(
          x = c("WHO Guideline", "US", "EPA Standard", "SoCal", "Los Angeles", "San Diego"),
          average_pm25 = c(5, 7.08, 9.0, 10.82, 9.79, 6.98)
        )
      ) |>
      mutate(
        average_pm25 = round(average_pm25, 2)
        ) |>
    filter(x %in% input$chosenSelection) |>
    mutate(x = fct_reorder(x, average_pm25)
      )

    ggplot(average_data, aes(x = x, y = average_pm25, fill = x)) +
      geom_col() +
      geom_text(
        aes(label = average_pm25),
        vjust = -0.3,
        size = 5
      ) +
      labs(
        y = bquote("Annual PM2.5 Average" ~(mu*g/m^3))
      ) +
      scale_fill_manual(values = pm25_colors, drop = FALSE
      ) +
      theme_classic() +
      theme(
        axis.title.x = element_blank(),
        legend.position = "none"
      )
  }
  else {
    average_data_AQI <- data_prepared |>
      filter(location == "outdoor") |>
      summarize(
        x = "Inland Empire 2025",
        average_aqi = mean(`AQI US`, na.rm = TRUE)
      ) |>
      bind_rows(
        data.frame(
          x = c("WHO Guideline", "US", "EPA Standard", "SoCal", "Los Angeles", "San Diego"),
          average_aqi = c(28, 39, 50, 54, 52, 39) #US average from IQAir, EPA from AQI scale, but maybe should be 100?
        )
      ) |>
      mutate(
        average_aqi = round(average_aqi, 2)
        ) |>
    filter(x %in% input$chosenSelection) |>
    mutate(x = fct_reorder(x, average_aqi)
      )

    ggplot(average_data_AQI, aes(x = x, y = average_aqi, fill = x)) +
      geom_col() +
      geom_text(
        aes(label = average_aqi),
        vjust = -0.3,
        size = 5
      ) +
      labs(
        y = "Annual AQI Average"
      ) +
      scale_fill_manual(values = pm25_colors, drop = FALSE
      ) +
      theme_classic() +
      theme(
        axis.title.x = element_blank(),
        legend.position = "none"
      )    
  }
})




# For cities, this works! But the selection doesn't work yet, I will figure this out later

output$citychart <- renderPlot({
  addressandserialnumbers <- monitors %>%
    select(serial,city)%>%
    rename(Source = serial)
  data_prepared <- data_prepared %>%
    mutate(Source = trimws(toupper(as.character(Source))))
  addressandserialnumbers <- addressandserialnumbers %>%
    mutate(Source = trimws(toupper(as.character(Source))))
  monitorswithcity <- addressandserialnumbers %>%
    left_join(data_prepared, by = "Source")
  monitorswithcity <- monitorswithcity %>%
    filter(!is.na(city))
  data_daily_city <- monitorswithcity |>
    group_by(month, day, city) |>
    summarize(`PM2.5` = mean(`PM2.5 (ug/m3)`),
            `PM10` = mean(`PM10 (ug/m3)`),
            `AQI` = mean(`AQI US`)) |>
    mutate(date = ymd(str_c('2025', month, day, sep = '-')))
  
  ggplot() +
    geom_smooth(data = data_daily_city,
              aes(x = date,
                 y = `PM2.5`, 
                 group = city, 
                 color = city), 
            span = 0.2, 
            alpha = 0.01) + 
    theme_bw()
})

</script>
 
<script type="application/shiny-prerendered" data-context="server">
data <- reactive({
  if (input$chosenTimescale == "Hourly"){
    data <- data_hourly
  } else if (input$chosenTimescale == "Daily"){
    data <- data_daily
  } else {
    data <- data_monthly
  }
  return(data)
  })

observeEvent(input$daterange, {
  updateDateRangeInput(
    session,
    "realdaterange",
    start = input$daterange[1],
    end = input$daterange[2]
  )
})

observeEvent(input$realdaterange, {
  updateSliderInput(
    session,
    "daterange",
    value = input$realdaterange
  )
})

output$timeseries <- renderPlot({
  req(input$chosenSelection)

    output_file <- 'data/PA_Combined.csv'

    all_PA_data <- read.csv(output_file)

    data_daily <- data_prepared |>
      group_by(month, day) |>
      summarize(`PM2.5` = mean(`PM2.5 (ug/m3)`),
                `PM10` = mean(`PM10 (ug/m3)`),
                `AQI` = mean(`AQI US`)) |>
      mutate(date = ymd(str_c('2025', month, day, sep = '-')))

    PA_monthly <- all_PA_data |>
      filter(pm2.5_atm < 325) |>
      mutate(time_stamp = ymd(str_sub(time_stamp, 1, 10))) |>
      mutate(year = year(time_stamp),
            month = month(time_stamp),
            day = 15) |>
      mutate(date = ymd(str_c(year, month, day, sep = '-'))) |>
      group_by(date) |>
      summarize(`PM2.5` = mean(`pm2.5_atm`),
                `PM10` = mean(`pm10.0_atm`))

    ggplot() +
      geom_smooth(data = PA_monthly,
                  aes(x = date,
                      y = PM2.5),
                  span = 0.25,
                  color = '#7777cc',
                  size = 5,
                  alpha = 0.01) +
      geom_hline(yintercept = 9) +
      geom_point(data = data_daily,
                 aes(x = date,
                     y = PM2.5),
                 size = 0.6,
                 color = '#dd6644') +
      geom_line(data = data_daily,
                aes(x = date,
                     y = PM2.5),
                 color = '#dd6644') +
      geom_smooth(data = data_daily,
                  aes(x = date,
                     y = PM2.5),
                  span = 0.2,
                 color = '#dd6644',
                 se = F) +
      #annotate("text", x = 20265, y = 8, label = "EPA Standard", size = 3) +
      #annotate("text", x = 20257, y = 11, label = "SoCal", size = 3, color = '#7777cc') +
      #annotate("text", x = 20266, y = 21, label = "IE", size = 3, color = '#dd6644') +
      labs(y = bquote('Daily PM2.5 Average' ~(mu*g/m^3)),
           x = 'Date',
           title = 'Particulates Over Time',
           #subtitle = 'IQAir Monitor Data, Public Health & Environmental Standards'
           ) +
      scale_x_date(limits = c(input$realdaterange[1], input$realdaterange[2])) +
      scale_y_continuous(limits = c(0, 40)) +
      theme_minimal()
})


</script>
 
<script type="application/shiny-prerendered" data-context="server">
library(psych)

# For indoor outdoor plot 

output$in_out_chart <- renderPlot({
  req(input$chosenSelection)

    describeBy(data_prepared[5], group = data_prepared$month, mat = T)

stats <- describeBy(data_prepared[c(5,7)],
                    list(data_prepared$month,
                         data_prepared$location),
                    mat = T)

stats_clean <- stats |>
  select(month = group1,
         location = group2,
         variable = vars,
         mean) |>
  mutate(variable = recode(
    variable,
    `1` = "AQI US mean",
    `2` = "PM2.5 mean"))

stats_wide <- stats_clean |>
  pivot_wider(
    names_from = variable,
    values_from = mean,
  )
stats_wide |>
  ggplot(aes(x = month,
             y = `PM2.5 mean`,
             fill = location)) +
  geom_col(position = "dodge") +
  theme_bw()
  })
</script>
 
<script type="application/shiny-prerendered" data-context="server-extras">
ojs_define <- function(..., .session = shiny::getDefaultReactiveDomain()) {
  quos <- rlang::enquos(...)
  vars <- rlang::list2(...)
  nm <- names(vars)
  if (is.null(nm)) {
    nm <- rep_len("", length(vars))
  }
  mapply(function(q, nm, val) {
    # Infer name, if possible
    if (nm == "") {
      tryCatch({
        nm <- rlang::as_name(q)
      }, error = function(e) {
        code <- paste(collapse = "\n", deparse(rlang::f_rhs(q)))
        stop("ojs_define() could not create a name for the argument: ", code)
      })
    }
    .session$output[[nm]] <- val
    outputOptions(.session$output, nm, suspendWhenHidden = FALSE)
    .session$sendCustomMessage("ojs-export", list(name = nm))
    NULL
  }, quos, nm, vars, SIMPLIFY = FALSE, USE.NAMES = FALSE)
  invisible()
}
</script>
</p>
<!--html_preserve-->
<script type="application/shiny-prerendered" data-context="dependencies">
{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["jquery"]},{"type":"character","attributes":{},"value":["3.7.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["jquery.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["1.11.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["bootstrap"]},{"type":"character","attributes":{},"value":["5.3.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["href"]}},"value":[{"type":"character","attributes":{},"value":["site_files/libs/bootstrap-5.3.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["viewport"]}},"value":[{"type":"character","attributes":{},"value":["width=device-width, initial-scale=1, shrink-to-fit=no"]}]},{"type":"character","attributes":{},"value":["bootstrap.bundle.min.js"]},{"type":"character","attributes":{},"value":["bootstrap.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"logical","attributes":{},"value":[true]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","all_files","package","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["bs3compat"]},{"type":"character","attributes":{},"value":["0.9.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["bs3compat/js"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["transition.js","tabs.js","bs3compat.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["bslib"]},{"type":"character","attributes":{},"value":["0.9.0"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["bslib-component-js"]},{"type":"character","attributes":{},"value":["0.9.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["components/dist"]}]},{"type":"NULL"},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["src"]}},"value":[{"type":"character","attributes":{},"value":["components.min.js"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["src","type"]}},"value":[{"type":"character","attributes":{},"value":["web-components.min.js"]},{"type":"character","attributes":{},"value":["module"]}]}]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["bslib"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.9.0"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["bslib-component-css"]},{"type":"character","attributes":{},"value":["0.9.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["components/dist"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["components.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["bslib"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.9.0"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["bslib-tag-require"]},{"type":"character","attributes":{},"value":["0.9.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["components"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["tag-require.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["bslib"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.9.0"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["ionrangeslider-javascript"]},{"type":"character","attributes":{},"value":["2.3.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/ionrangeslider"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/ion.rangeSlider.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.11.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["strftime"]},{"type":"character","attributes":{},"value":["0.9.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/strftime"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["strftime-min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.11.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["ionrangeslider-css"]},{"type":"character","attributes":{},"value":["2.3.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/ionrangeslider"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["css/ion.rangeSlider.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.11.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["bootstrap-datepicker-js"]},{"type":"character","attributes":{},"value":["1.9.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/datepicker"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/bootstrap-datepicker.min.js"]},{"type":"NULL"},{"type":"character","attributes":{},"value":["<script>(function() {\n        var datepicker = $.fn.datepicker.noConflict();\n        $.fn.bsDatepicker = datepicker;\n      })();\n     <\/script>"]},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.11.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["bootstrap-datepicker-css"]},{"type":"character","attributes":{},"value":["1.9.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/datepicker"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["css/bootstrap-datepicker3.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.11.1"]}]}]}
</script>
<!--/html_preserve-->
<!--html_preserve-->
<script type="application/shiny-prerendered" data-context="execution_dependencies">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages","version"]},"class":{"type":"character","attributes":{},"value":["data.frame"]},"row.names":{"type":"integer","attributes":{},"value":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78]}},"value":[{"type":"character","attributes":{},"value":["base","bit","bit64","bslib","cachem","cellranger","cli","compiler","crayon","curl","datasets","digest","dplyr","evaluate","farver","fastmap","forcats","fs","generics","ggplot2","glue","graphics","grDevices","grid","gtable","hms","htmltools","htmlwidgets","httpuv","httr","jquerylib","jsonlite","knitr","later","lifecycle","lubridate","magrittr","memoise","methods","mime","otel","parallel","pillar","pkgconfig","promises","purrr","R6","RColorBrewer","Rcpp","readr","readxl","rlang","rmarkdown","rsconnect","rstudioapi","S7","sass","scales","shiny","stats","stringi","stringr","tibble","tidygeocoder","tidyr","tidyselect","tidyverse","timechange","tools","tzdb","utils","vctrs","vroom","withr","writexl","xfun","xtable","yaml"]},{"type":"character","attributes":{},"value":["4.5.2","4.6.0","4.6.0-1","0.9.0","1.1.0","1.1.0","3.6.5","4.5.2","1.5.3","7.0.0","4.5.2","0.6.37","1.1.4","1.0.5","2.1.2","1.2.0","1.0.1","1.6.6","0.1.4","4.0.0","1.8.0","4.5.2","4.5.2","4.5.2","0.3.6","1.1.4","0.5.8.1","1.6.4","1.6.16","1.4.7","0.1.4","2.0.0","1.50","1.4.4","1.0.4","1.9.4","2.0.4","2.0.1","4.5.2","0.13","0.2.0","4.5.2","1.11.1","2.0.3","1.5.0","1.2.0","2.6.1","1.1-3","1.1.0","2.1.5","1.4.5","1.1.6","2.30","1.6.2","0.17.1","0.2.0","0.4.10","1.4.0","1.11.1","4.5.2","1.8.7","1.6.0","3.3.0","1.0.6","1.3.1","1.2.1","2.0.0","0.3.0","4.5.2","0.5.0","4.5.2","0.6.5","1.6.6","3.0.2","1.5.4","0.54","1.8-4","2.3.10"]}]}]}
</script>
<!--/html_preserve-->

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>